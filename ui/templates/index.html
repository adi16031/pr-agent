<!doctype html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PR-Agent ‚Äî Repo UI</title>
    <style>
      :root[data-theme="light"] {
        --bg-primary: #ffffff;
        --bg-secondary: #f8f9fa;
        --bg-tertiary: #f1f3f5;
        --bg-hover: #e9ecef;
        --bg-selected: #e3f2fd;
        --border-color: #dee2e6;
        --border-light: #e9ecef;
        --text-primary: #212529;
        --text-secondary: #6c757d;
        --text-muted: #868e96;
        --accent-primary: #2196f3;
        --accent-hover: #1976d2;
        --success-bg: #d4edda;
        --success-text: #155724;
        --success-border: #c3e6cb;
        --error-bg: #f8d7da;
        --error-text: #721c24;
        --error-border: #f5c6cb;
        --info-bg: #e7f3ff;
        --info-text: #004085;
        --info-border: #b3d9ff;
        --modal-overlay: rgba(0, 0, 0, 0.5);
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
      }
      
      :root[data-theme="dark"] {
        --bg-primary: #1a1a1a;
        --bg-secondary: #242424;
        --bg-tertiary: #2d2d2d;
        --bg-hover: #333333;
        --bg-selected: #1e3a5f;
        --border-color: #404040;
        --border-light: #333333;
        --text-primary: #e9ecef;
        --text-secondary: #adb5bd;
        --text-muted: #868e96;
        --accent-primary: #42a5f5;
        --accent-hover: #64b5f6;
        --success-bg: #1e4620;
        --success-text: #a3d9a5;
        --success-border: #2d5f2e;
        --error-bg: #5a1a1a;
        --error-text: #f1aeb5;
        --error-border: #842029;
        --info-bg: #1a3a52;
        --info-text: #9fc5e8;
        --info-border: #2c5282;
        --modal-overlay: rgba(0, 0, 0, 0.7);
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
        --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
      }
      
      * { margin: 0; padding: 0; box-sizing: border-box; }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        transition: background-color 0.3s ease, color 0.3s ease;
      }
      
      /* Header */
      .header {
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
        padding: 12px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: var(--shadow-sm);
      }
      
      .header-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .header-actions {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      
      /* Theme Switcher */
      .theme-switcher {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 4px;
        display: flex;
        gap: 4px;
        cursor: pointer;
      }
      
      .theme-btn {
        background: transparent;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        color: var(--text-secondary);
        transition: all 0.2s ease;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .theme-btn.active {
        background: var(--accent-primary);
        color: white;
      }
      
      .theme-btn:hover:not(.active) {
        background: var(--bg-hover);
      }
      
      /* Settings Button */
      .settings-btn {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      
      .settings-btn:hover {
        background: var(--bg-hover);
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
      }
      
      /* Container */
      #container {
        display: flex;
        height: calc(100vh - 57px);
      }
      
      /* Left Sidebar */
      #left {
        width: 300px;
        border-right: 1px solid var(--border-color);
        padding: 20px;
        overflow-y: auto;
        background: var(--bg-secondary);
      }
      
      #left h3 {
        font-size: 14px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-muted);
        margin-bottom: 16px;
      }
      
      /* Right Content */
      #right {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
        background: var(--bg-primary);
      }
      
      #right h3 {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 20px;
        color: var(--text-primary);
      }
      
      /* Repo Items */
      .repo-item {
        padding: 12px 14px;
        cursor: pointer;
        border-radius: 8px;
        margin-bottom: 6px;
        transition: all 0.2s ease;
        font-size: 14px;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      
      .repo-item:hover {
        background: var(--bg-hover);
        transform: translateX(4px);
      }
      
      .selected {
        background: var(--bg-selected) !important;
        font-weight: 500;
      }
      
      /* Badges */
      .automated-badge {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      /* Buttons */
      button {
        font-family: inherit;
      }
      
      .automation-btn {
        background: var(--accent-primary);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        box-shadow: var(--shadow-sm);
      }
      
      .automation-btn:hover {
        background: var(--accent-hover);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
      }
      
      .automation-btn:disabled {
        background: var(--text-muted);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      
      .btn-primary {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        box-shadow: var(--shadow-sm);
      }
      
      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
      }
      
      .btn-primary:disabled {
        background: var(--text-muted);
        cursor: not-allowed;
        transform: none;
      }
      
      .btn-github-sso {
        background: #24292e;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        box-shadow: var(--shadow-sm);
      }
      
      .btn-github-sso:hover {
        background: #1b1f23;
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
      }
      
      .btn-github-sso:disabled {
        background: var(--text-muted);
        cursor: not-allowed;
      }
      
      /* Status Messages */
      .automation-status,
      .token-status {
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 16px;
        font-size: 13px;
        border: 1px solid;
      }
      
      .status-success {
        background: var(--success-bg);
        color: var(--success-text);
        border-color: var(--success-border);
      }
      
      .status-error {
        background: var(--error-bg);
        color: var(--error-text);
        border-color: var(--error-border);
      }
      
      .info-box {
        background: var(--info-bg);
        border: 1px solid var(--info-border);
        color: var(--info-text);
        padding: 12px;
        border-radius: 8px;
        font-size: 13px;
        margin-bottom: 16px;
      }
      
      /* Pre/Code */
      pre {
        background: var(--bg-tertiary);
        padding: 16px;
        border-radius: 8px;
        overflow: auto;
        font-size: 13px;
        border: 1px solid var(--border-color);
        color: var(--text-primary);
      }
      
      code {
        background: var(--bg-tertiary);
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 12px;
        font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
      }
      
      /* Modal */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: var(--modal-overlay);
        backdrop-filter: blur(4px);
        animation: fadeIn 0.2s ease;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      .modal-content {
        background-color: var(--bg-primary);
        margin: 5% auto;
        padding: 28px;
        border-radius: 12px;
        width: 520px;
        max-width: 90%;
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--border-color);
        animation: slideUp 0.3s ease;
      }
      
      @keyframes slideUp {
        from {
          transform: translateY(20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border-light);
      }
      
      .modal-header h2 {
        margin: 0;
        font-size: 22px;
        font-weight: 600;
        color: var(--text-primary);
      }
      
      .close-btn {
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
        color: var(--text-muted);
        transition: color 0.2s ease;
        line-height: 1;
      }
      
      .close-btn:hover {
        color: var(--text-primary);
      }
      
      /* Form Elements */
      .form-group {
        margin-bottom: 20px;
      }
      
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        font-size: 14px;
        color: var(--text-primary);
      }
      
      .form-group input {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 14px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        transition: all 0.2s ease;
      }
      
      .form-group input:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
      }
      
      .form-group small {
        color: var(--text-muted);
        font-size: 12px;
        display: block;
        margin-top: 6px;
      }
      
      /* Divider */
      .divider {
        display: flex;
        align-items: center;
        margin: 24px 0;
        color: var(--text-muted);
        font-size: 13px;
        font-weight: 500;
      }
      
      .divider::before,
      .divider::after {
        content: '';
        flex: 1;
        border-bottom: 1px solid var(--border-light);
      }
      
      .divider span {
        padding: 0 16px;
      }
      
      /* Controls */
      #controls {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        align-items: center;
      }
      
      #controls input {
        flex: 1;
        padding: 10px 14px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 14px;
        background: var(--bg-secondary);
        color: var(--text-primary);
      }
      
      #controls input:focus {
        outline: none;
        border-color: var(--accent-primary);
      }
      
      #controls button {
        padding: 10px 18px;
        background: var(--accent-primary);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
      }
      
      #controls button:hover {
        background: var(--accent-hover);
        transform: translateY(-1px);
      }
      
      /* PR List */
      .pr-item {
        padding: 16px;
        border-bottom: 1px solid var(--border-light);
        transition: background 0.2s ease;
      }
      
      .pr-item:hover {
        background: var(--bg-secondary);
      }
      
      .pr-item:last-child {
        border-bottom: none;
      }
      
      /* Scrollbar Styling */
      ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }
      
      ::-webkit-scrollbar-track {
        background: var(--bg-secondary);
      }
      
      ::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 5px;
      }
      
      ::-webkit-scrollbar-thumb:hover {
        background: var(--text-muted);
      }
      
      /* Animations */
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      
      .loading {
        animation: pulse 1.5s ease-in-out infinite;
      }

      /* Vulnerability Scan Overlay */
      .scan-overlay {
        position: fixed;
        inset: 0;
        background: var(--modal-overlay);
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 12px;
        z-index: 1100;
        backdrop-filter: blur(3px);
      }

      .scan-spinner {
        width: 52px;
        height: 52px;
        border-radius: 50%;
        border: 5px solid var(--border-color);
        border-top-color: var(--accent-primary);
        animation: spin 0.9s linear infinite;
      }

      .scan-text {
        color: var(--text-primary);
        font-weight: 500;
      }

      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="header">
      <div class="header-title">
        <span>ü§ñ</span>
        PR-Agent
      </div>
      <div class="header-actions">
        <div class="theme-switcher">
          <button class="theme-btn active" data-theme="light" onclick="setTheme('light')" title="Light Mode">
            ‚òÄÔ∏è
          </button>
          <button class="theme-btn" data-theme="dark" onclick="setTheme('dark')" title="Dark Mode">
            üåô
          </button>
        </div>
        <button class="settings-btn" onclick="openSettings()">
          <span>‚öôÔ∏è</span>
          <span>Settings</span>
        </button>
      </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>GitHub Settings</h2>
          <button class="close-btn" onclick="closeSettings()">&times;</button>
        </div>
        <div id="tokenStatusDiv" class="token-status" style="display:none;"></div>
        
        <!-- SSO Section -->
        <div class="sso-section" id="ssoSection" style="display:none;">
          <div class="info-box">
            <strong>Quick Setup:</strong> Authorize with GitHub to automatically configure your access token.
          </div>
          <button id="githubSSOBtn" class="btn-github-sso" onclick="initiateGitHubSSO()">
            <span class="github-icon">
              <svg height="16" width="16" viewBox="0 0 16 16" fill="currentColor" style="vertical-align:text-bottom">
                <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
              </svg>
            </span>
            Sign in with GitHub
          </button>
        </div>
        
        <div class="divider" id="dividerSection" style="display:none;"><span>OR</span></div>
        
        <!-- Manual Token Section -->
        <div class="form-group">
          <label for="githubToken">GitHub Personal Access Token</label>
          <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
          <small>Token is stored in pr_agent/settings/.secrets.toml. Requires 'repo' and 'workflow' scopes.</small>
        </div>
        <div class="form-group">
          <button id="saveTokenBtn" class="btn-primary" onclick="saveGithubToken()">Save Token</button>
        </div>
        <div style="margin-top:20px; padding:14px; background:var(--bg-tertiary); border-radius:8px; font-size:13px; color:var(--text-secondary); border:1px solid var(--border-light);">
          <strong style="color:var(--text-primary);">How to create a GitHub token:</strong><br>
          1. Go to GitHub Settings ‚Üí Developer settings ‚Üí Personal access tokens ‚Üí Tokens (classic)<br>
          2. Generate new token with <code>repo</code> and <code>workflow</code> scopes<br>
          3. Copy and paste the token here
        </div>
      </div>
    </div>
    
    <div id="container">
      <div id="left">
        <h3>Repositories</h3>
        <div id="repos"></div>
      </div>
      <div id="right">
        <h3 id="title">Select a repo</h3>
        <div id="automation-section" style="display:none; margin-bottom:16px;">
          <button id="btn_toggle_automation" class="automation-btn">Enable Automated PR Review</button>
          <div id="automation-status" class="automation-status" style="display:none;"></div>
          <p style="font-size:13px; color:var(--text-muted); margin-top:8px;">
            When enabled, all new PRs will automatically get review, description, and improvement suggestions.
          </p>
        </div>
        <div id="vuln-section" style="display:none; margin-bottom:16px;">
          <button id="btn_scan_vuln" class="automation-btn" style="background: linear-gradient(135deg, #f59f00, #f76707);">Scan Vulnerabilities & Raise PR</button>
          <div id="vuln-status" class="automation-status" style="display:none;"></div>
          <p style="font-size:13px; color:var(--text-muted); margin-top:8px;">
            Triggers a GitHub Actions workflow on the repo to run pip-audit remotely and open a PR with the report.
          </p>
        </div>
        <div id="controls" style="margin-bottom:12px; display:none">
          <input id="pr_url" type="text" placeholder="https://github.com/org/repo/pull/123" style="width:70%" />
          <button id="btn_review">Review</button>
          <button id="btn_describe">Describe</button>
          <button id="btn_improve">Improve</button>
        </div>
        <div id="content">Click a repository on the left to view details.</div>
        <pre id="stream_output" style="white-space:pre-wrap; max-height:40vh; overflow:auto; display:none"></pre>
      </div>
    </div>

    <div id="scan-overlay" class="scan-overlay">
      <div class="scan-spinner"></div>
      <div class="scan-text">Scanning repository for vulnerabilities...</div>
    </div>

    <script>
      let currentOwner = null
      let currentName = null
      let currentFullname = null
      // Theme Management
      function initTheme() {
        const savedTheme = localStorage.getItem('pr_agent_theme') || 'light';
        setTheme(savedTheme, false);
      }
      
      function setTheme(theme, save = true) {
        document.documentElement.setAttribute('data-theme', theme);
        
        // Update button states
        document.querySelectorAll('.theme-btn').forEach(btn => {
          if (btn.getAttribute('data-theme') === theme) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });
        
        if (save) {
          localStorage.setItem('pr_agent_theme', theme);
        }
      }
      
      // Initialize theme on page load
      initTheme();
      
      // LocalStorage helpers for automated repos
      function getAutomatedRepos() {
        const stored = localStorage.getItem('pr_agent_automated_repos')
        return stored ? JSON.parse(stored) : []
      }
      
      function isRepoAutomated(fullName) {
        const automated = getAutomatedRepos()
        return automated.includes(fullName)
      }
      
      function addAutomatedRepo(fullName) {
        const automated = getAutomatedRepos()
        if (!automated.includes(fullName)) {
          automated.push(fullName)
          localStorage.setItem('pr_agent_automated_repos', JSON.stringify(automated))
        }
      }
      
      function removeAutomatedRepo(fullName) {
        const automated = getAutomatedRepos()
        const filtered = automated.filter(r => r !== fullName)
        localStorage.setItem('pr_agent_automated_repos', JSON.stringify(filtered))
      }

      async function fetchRepos(){
        const res = await fetch('/api/github/repos')
        const data = await res.json()
        const container = document.getElementById('repos')
        container.innerHTML = ''
        if(data.error){ container.innerHTML = '<div style="color:red">'+data.error+'</div>'; return }
        data.repos.forEach(r => {
          const el = document.createElement('div')
          el.className = 'repo-item'
          el.textContent = r.full_name
          
          // Add automated badge if this repo is automated
          if (isRepoAutomated(r.full_name)) {
            const badge = document.createElement('span')
            badge.className = 'automated-badge'
            badge.textContent = 'AUTO'
            el.appendChild(badge)
          }
          
          el.onclick = () => showGithubRepo(r.owner, r.name)
          container.appendChild(el)
        })
      }

      async function showGithubRepo(owner, name){
        const fullname = owner + '/' + name
        currentOwner = owner
        currentName = name
        currentFullname = fullname
        // clear selected
        document.querySelectorAll('.repo-item').forEach(e=>e.classList.remove('selected'))
        document.querySelectorAll('.repo-item').forEach(e=>{ 
          const text = e.childNodes[0].textContent || e.textContent
          if(text === fullname) e.classList.add('selected') 
        })
        const title = document.getElementById('title')
        const content = document.getElementById('content')
        title.textContent = fullname
        content.innerHTML = `
          <p><strong>Repository:</strong> ${fullname}</p>
          <div id="pr-section">
            <p><strong>Open PRs:</strong></p>
            <div id="pr-list">Loading PRs...</div>
          </div>
        `
        // show automation section
        const automationSection = document.getElementById('automation-section')
        automationSection.style.display = 'block'
        const automationBtn = document.getElementById('btn_toggle_automation')
        const automationStatus = document.getElementById('automation-status')
        automationStatus.style.display = 'none'
        
        const isAutomated = isRepoAutomated(fullname)
        automationBtn.textContent = isAutomated ? 'Disable Automated PR Review' : 'Enable Automated PR Review'
        automationBtn.disabled = false
        automationBtn.onclick = () => toggleAutomation(owner, name)

        // vulnerability scan controls
        const vulnSection = document.getElementById('vuln-section')
        const vulnStatus = document.getElementById('vuln-status')
        const scanBtn = document.getElementById('btn_scan_vuln')
        vulnSection.style.display = 'block'
        vulnStatus.style.display = 'none'
        scanBtn.disabled = false
        scanBtn.textContent = 'Scan Vulnerabilities & Raise PR'
        scanBtn.onclick = () => scanVulnerabilities()
        
        // show controls
        document.getElementById('controls').style.display = 'block'
        document.getElementById('stream_output').style.display = 'none'
        // attach button handlers (these will post to run endpoint with repoName)
        document.getElementById('btn_review').onclick = ()=>runAction(fullname,'review')
        document.getElementById('btn_describe').onclick = ()=>runAction(fullname,'describe')
        document.getElementById('btn_improve').onclick = ()=>runAction(fullname,'improve')

        fetch(`/api/github/repos/${owner}/${name}/prs`).then(r=>r.json()).then(j=>{
          const list = document.getElementById('pr-list')
          if(j.error){ list.innerHTML = 'Error: '+j.error; return }
          if(!j.prs || j.prs.length==0){ list.innerHTML = 'No open PRs' ; return }
          list.innerHTML = ''
          j.prs.forEach(pr=>{
            const item = document.createElement('div')
            item.style.padding='8px'
            item.style.borderBottom='1px solid #eee'
            item.innerHTML = `<strong>#${pr.number}</strong> ${pr.title} <small>by ${pr.user}</small>`
            const btns = document.createElement('span')
            btns.style.float='right'
            const reviewBtn = document.createElement('button')
            reviewBtn.textContent = 'Review'
            reviewBtn.onclick = ()=> runAction(fullname,'review', pr.html_url)
            const descBtn = document.createElement('button')
            descBtn.textContent = 'Describe'
            descBtn.style.marginLeft='6px'
            descBtn.onclick = ()=> runAction(fullname,'describe', pr.html_url)
            const impBtn = document.createElement('button')
            impBtn.textContent = 'Improve'
            impBtn.style.marginLeft='6px'
            impBtn.onclick = ()=> runAction(fullname,'improve', pr.html_url)
            btns.appendChild(reviewBtn)
            btns.appendChild(descBtn)
            btns.appendChild(impBtn)
            item.appendChild(btns)
            list.appendChild(item)
          })
        })
      }

      async function runAction(repoName, action){
        // prUrl may be provided when action is triggered from a PR row
        let prUrl = document.getElementById('pr_url').value.trim()
        if(arguments.length>=3 && arguments[2]) prUrl = arguments[2]
        if(!prUrl){ alert('Enter PR URL'); return }
        const out = document.getElementById('stream_output')
        out.style.display = 'block'
        out.textContent = ''

        const res = await fetch(`/api/run`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({repo: repoName, action: action, pr_url: prUrl})
        })

        if(!res.ok){
          const err = await res.json()
          out.textContent = 'Error: '+JSON.stringify(err)
          return
        }

        const reader = res.body.getReader()
        const decoder = new TextDecoder()
        while(true){
          const {done, value} = await reader.read()
          if(done) break
          const chunk = decoder.decode(value)
          out.textContent += chunk
          out.scrollTop = out.scrollHeight
        }
      }
      
      async function toggleAutomation(owner, name) {
        const fullname = owner + '/' + name
        const isAutomated = isRepoAutomated(fullname)
        const automationBtn = document.getElementById('btn_toggle_automation')
        const automationStatus = document.getElementById('automation-status')
        
        automationBtn.disabled = true
        automationStatus.style.display = 'block'
        automationStatus.className = 'automation-status'
        automationStatus.textContent = isAutomated ? 'Disabling automation...' : 'Setting up GitHub Actions...'
        
        if (isAutomated) {
          // Just remove from localStorage (workflow remains in repo but can be manually deleted)
          removeAutomatedRepo(fullname)
          automationBtn.textContent = 'Enable Automated PR Review'
          automationStatus.className = 'automation-status status-success'
          automationStatus.textContent = 'Automation disabled. The workflow file remains in the repository.'
          automationBtn.disabled = false
          fetchRepos() // Refresh to remove badge
        } else {
          // Setup GitHub Actions
          try {
            const res = await fetch(`/api/github/repos/${owner}/${name}/setup-automation`, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'}
            })
            const data = await res.json()
            
            if (data.success) {
              addAutomatedRepo(fullname)
              automationBtn.textContent = 'Disable Automated PR Review'
              automationStatus.className = 'automation-status status-success'
              automationStatus.textContent = `‚úì ${data.message}. All new PRs will be automatically reviewed!`
              fetchRepos() // Refresh to show badge
            } else {
              automationStatus.className = 'automation-status status-error'
              const errorMsg = data.error || 'Unknown error'
              automationStatus.innerHTML = `<strong>‚úó Error:</strong> ${errorMsg}<br><small>Make sure your GitHub token has "workflow" and "repo" scopes.</small>`
            }
            automationBtn.disabled = false
          } catch (e) {
            automationStatus.className = 'automation-status status-error'
            automationStatus.textContent = `‚úó Error: ${e.message}`
            automationBtn.disabled = false
          }
        }
      }

      function toggleScanOverlay(show, message = 'Scanning repository for vulnerabilities...') {
        const overlay = document.getElementById('scan-overlay')
        const text = overlay.querySelector('.scan-text')
        text.textContent = message
        overlay.style.display = show ? 'flex' : 'none'
      }

      async function scanVulnerabilities() {
        if (!currentOwner || !currentName) {
          alert('Select a repository first')
          return
        }

        const vulnStatus = document.getElementById('vuln-status')
        const scanBtn = document.getElementById('btn_scan_vuln')
        vulnStatus.style.display = 'block'
        vulnStatus.className = 'automation-status'
        vulnStatus.textContent = 'Dispatching GitHub Actions workflow...'
        scanBtn.disabled = true
        toggleScanOverlay(true)

        try {
          const res = await fetch(`/api/github/repos/${currentOwner}/${currentName}/vulnerability-scan`, { method: 'POST' })
          const data = await res.json()
          if (res.ok && data.success) {
            vulnStatus.className = 'automation-status status-success'
            const wfLink = data.workflow_url ? `<a href="${data.workflow_url}" target="_blank" rel="noopener">View workflow</a>` : 'Workflow'
            vulnStatus.innerHTML = `‚úì Workflow dispatched on ${data.ref || 'default branch'}. ${wfLink}. A PR will be opened by the action when the scan completes.`
          } else {
            vulnStatus.className = 'automation-status status-error'
            const err = data.error || 'Scan dispatch failed'
            vulnStatus.textContent = `‚úó ${err}`
          }
        } catch (e) {
          vulnStatus.className = 'automation-status status-error'
          vulnStatus.textContent = `‚úó ${e.message}`
        } finally {
          scanBtn.disabled = false
          toggleScanOverlay(false)
        }
      }

      // Settings Modal Functions
      async function openSettings() {
        document.getElementById('settingsModal').style.display = 'block'
        
        // Check OAuth configuration
        try {
          const oauthRes = await fetch('/api/settings/oauth-config')
          const oauthData = await oauthRes.json()
          
          const ssoSection = document.getElementById('ssoSection')
          const dividerSection = document.getElementById('dividerSection')
          
          if (oauthData.enabled) {
            ssoSection.style.display = 'block'
            dividerSection.style.display = 'flex'
          } else {
            ssoSection.style.display = 'none'
            dividerSection.style.display = 'none'
          }
        } catch (e) {
          console.error('Failed to check OAuth config:', e)
        }
        
        // Load current token status
        try {
          const res = await fetch('/api/settings/github-token')
          const data = await res.json()
          const statusDiv = document.getElementById('tokenStatusDiv')
          
          if (data.configured) {
            statusDiv.style.display = 'block'
            statusDiv.className = 'token-status status-success'
            statusDiv.innerHTML = `‚úì Token configured (${data.source}): ${data.token}`
          } else {
            statusDiv.style.display = 'block'
            statusDiv.className = 'token-status status-error'
            statusDiv.textContent = '‚ö† No GitHub token configured'
          }
        } catch (e) {
          console.error('Failed to load token status:', e)
        }
      }
      
      function closeSettings() {
        document.getElementById('settingsModal').style.display = 'none'
        document.getElementById('githubToken').value = ''
      }
      
      function initiateGitHubSSO() {
        const statusDiv = document.getElementById('tokenStatusDiv')
        const ssoBtn = document.getElementById('githubSSOBtn')
        
        // Open OAuth flow in popup
        const width = 600
        const height = 700
        const left = (screen.width - width) / 2
        const top = (screen.height - height) / 2
        
        const popup = window.open(
          '/auth/github',
          'GitHub OAuth',
          `width=${width},height=${height},left=${left},top=${top},toolbar=no,menubar=no,scrollbars=yes`
        )
        
        // Listen for OAuth result
        window.addEventListener('message', function handleOAuthResult(event) {
          if (event.data.type === 'github_oauth_result') {
            if (event.data.success) {
              statusDiv.style.display = 'block'
              statusDiv.className = 'token-status status-success'
              statusDiv.textContent = '‚úì Successfully authorized with GitHub! Token has been saved.'
              
              // Refresh repos after successful auth
              setTimeout(() => {
                fetchRepos()
                closeSettings()
              }, 2000)
            } else {
              statusDiv.style.display = 'block'
              statusDiv.className = 'token-status status-error'
              statusDiv.textContent = '‚úó OAuth failed: ' + (event.data.error || 'Unknown error')
            }
            
            // Remove event listener after handling
            window.removeEventListener('message', handleOAuthResult)
          }
        })
      }
      
      async function saveGithubToken() {
        const token = document.getElementById('githubToken').value.trim()
        const statusDiv = document.getElementById('tokenStatusDiv')
        const saveBtn = document.getElementById('saveTokenBtn')
        
        if (!token) {
          statusDiv.style.display = 'block'
          statusDiv.className = 'token-status status-error'
          statusDiv.textContent = '‚ö† Please enter a token'
          return
        }
        
        saveBtn.disabled = true
        saveBtn.textContent = 'Saving...'
        
        try {
          const res = await fetch('/api/settings/github-token', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({token: token})
          })
          const data = await res.json()
          
          if (data.success) {
            statusDiv.style.display = 'block'
            statusDiv.className = 'token-status status-success'
            statusDiv.textContent = '‚úì ' + data.message
            document.getElementById('githubToken').value = ''
            // Refresh repos with new token
            setTimeout(() => {
              fetchRepos()
              closeSettings()
            }, 1500)
          } else {
            statusDiv.style.display = 'block'
            statusDiv.className = 'token-status status-error'
            statusDiv.textContent = '‚úó ' + (data.error || 'Failed to save token')
          }
        } catch (e) {
          statusDiv.style.display = 'block'
          statusDiv.className = 'token-status status-error'
          statusDiv.textContent = '‚úó Error: ' + e.message
        } finally {
          saveBtn.disabled = false
          saveBtn.textContent = 'Save Token'
        }
      }
      
      // Close modal when clicking outside
      window.onclick = function(event) {
        const modal = document.getElementById('settingsModal')
        if (event.target === modal) {
          closeSettings()
        }
      }

      fetchRepos()
    </script>
  </body>
</html>
